<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Cattle Registry</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
      table { font-size: 0.9rem; width: 100%; border-collapse: collapse; text-align: left; margin-bottom: 20px; }
      th, td { padding: 10px; border: 1px solid #ddd; }
      th { background-color: #f8f9fa; font-weight: 600; }
      tbody tr.data-row:hover { background: #f9fcff; }
      tbody tr.more-info-row { background: #fafafa; }
      tbody tr.data-row:nth-child(4n+1) { background: #ffffff; }
      tbody tr.data-row:nth-child(4n+3) { background: #f5f9ff; }
      .table-container { overflow-x: auto; margin-bottom: 20px; }
      h2 { margin-top: 20px; }
      .add-button { padding: 5px 10px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; font-size: 0.9rem; margin-left: 10px; cursor: pointer; border:none; }
      .add-button:hover { background-color: #218838; }
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); }
      .modal-content { background-color: #fefefe; margin: 6% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; position: relative; }
      .close { color: #aaa; position:absolute; top:8px; right:12px; font-size: 28px; font-weight: bold; cursor: pointer; }
      .close:hover { color: black; }
      .toast { position: fixed; bottom: 20px; left: 16px; z-index: 1001; display:none; pointer-events: none; }
      .toast .toast-item { background:#111; color:#fff; padding:12px 16px; border-radius:10px; margin-top:10px; box-shadow:0 10px 24px rgba(0,0,0,.2); min-width:240px; pointer-events:auto; font-size:.8rem; }
      .toast .success { background:#198754; } .toast .error { background:#dc3545; } .toast .info { background:#0d6efd; }
      .search-container { position: sticky; top: 64px; background-color: white; z-index: 10; padding: 10px; display:flex; flex-direction:column; gap:10px; align-items:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
      .search-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .advanced-panel { display:none; padding:10px; border:1px solid #eee; border-radius:6px; background:#fbfbfb; width:100%; }
      .advanced-grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px 12px; margin-top:8px; }
      .advanced-grid label { font-size:0.75rem; color:#333; display:flex; flex-direction:column; gap:4px; }
      .advanced-grid input, .advanced-grid select { width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:4px; font-size:0.75rem; }
      .form-grid { display:grid; grid-template-columns: 1fr 2fr; gap:8px 16px; align-items:center; }
      .form-grid label { font-weight:600; }
      .form-grid input, .form-grid select, .form-grid textarea { width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:4px; font-size:0.85rem; }
      .detail-grid { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
      .detail-grid label { display:block; font-weight:600; color:#333; }
      .detail-grid span { display:block; color:#555; }
      .error-banner { background:#fde2e4; color:#842029; border:1px solid #f5c2c7; padding:8px 10px; border-radius:6px; margin-bottom:10px; font-weight:600; }
      .invalid { border-color:#dc3545 !important; background:#fff5f6; }
      .error-text { color:#dc3545; font-size:0.75rem; margin-top:4px; display:block; }
      .notes-content { white-space:pre-wrap; margin-top:6px; padding:8px; background:#f9f9f9; border:1px solid #eee; border-radius:4px; font-size:0.75rem; }
      .parent-meta { font-size:0.65rem; color:#555; margin:4px 0 8px; }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <main class="content" style="padding:20px;">
  <h1 style="margin-top:0;">Cattle Registry</h1>
  <a href="/cattle-management" style="padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 8px; display:inline-block;">Back to Cattle Management</a>

  <section style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-cows" style="padding:6px 10px;background:#198754;color:#fff;border:none;border-radius:6px;cursor:pointer;" onclick="scrollToSection('cows-section')">Cows</button>
    <button class="btn btn-bulls" style="padding:6px 10px;background:#6f42c1;color:#fff;border:none;border-radius:6px;cursor:pointer;" onclick="scrollToSection('bulls-section')">Bulls</button>
    <button class="btn btn-calves" style="padding:6px 10px;background:#ff9800;color:#fff;border:none;border-radius:6px;cursor:pointer;" onclick="scrollToSection('calves-section')">Calves</button>
  </section>
  <!-- Sidebar navigation restored -->
  <nav class="sidebar" id="sidebar">
    <div class="brand" style="display:flex; align-items:center;">
      <button class="close-sidebar" aria-label="Close navigation" style="background:transparent; border:none; cursor:pointer; margin-right:10px; position:relative;">
        <span style="display:block; width:20px; height:2px; background:black; transform:rotate(45deg); position:absolute; top:50%; left:50%; transform-origin:center; margin:-1px 0 0 -10px;"></span>
        <span style="display:block; width:20px; height:2px; background:black; transform:rotate(-45deg); position:absolute; top:50%; left:50%; transform-origin:center; margin:-1px 0 0 -10px;"></span>
      </button>
      <img src="/images/icons/logo.png" alt="Ferma Tech Logo" style="width:48px; height:48px; object-fit:contain; border-radius:8px; margin-right:8px;">
      <h1 style="font-size:1.4rem; margin:0;">Ferma Tech</h1>
    </div>
    <ul class="nav" style="list-style:none; padding:0; margin:16px 0;">
      <li><a href="/">Home</a></li>
      <li><a href="/community/dashboard">Farm Stats</a></li>
      <li><a href="/cattle-viewer">Cattle Viewer</a></li>
      <li><a href="/cattle-registry" class="active">Cattle Registry</a></li>
      <li><a href="/community/members">Members</a></li>
      <li><a href="/community/settings">Farm Settings</a></li>
      <li><a href="/community/data">Import/Export</a></li>
      <% if (typeof user !== 'undefined' && user && user.role === 'SuperAdmin') { %>
      <li><a href="/admin">Super Admin</a></li>
      <% } %>
    </ul>
    <footer style="margin-top:auto; padding:12px 0;">
      <span class="tag" style="font-size:.85rem; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; background:#f1f3f5; border-radius:20px;">
        <span class="dot" style="width:10px; height:10px; background:#28a745; border-radius:50%; display:inline-block;"></span> <% if (typeof user !== 'undefined' && user) { %><%= user.firstName %><% } else { %>Online<% } %>
      </span>
    </footer>
  </nav>

  <!-- Cows Section -->
  <section id="cows-section">
    <h2>Cows <button class="add-button" onclick="openAddModal('cow')">Add Cow</button></h2>
    <div class="table-container">
      <table class="cow-table">
        <thead>
          <tr>
            <th>Cow #</th>
            <th>Name</th>
            <th>Breed</th>
            <th>DOB</th>
            <th>Notes</th>
            <th>More Info</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% cows.forEach(cow => { %>
            <tr id="cow-row-<%= cow._id %>" class="data-row" data-id="<%= cow._id %>" data-number="<%= cow.cowNumber || '' %>" data-name="<%= cow.cowName || '' %>" data-breed="<%= cow.race || '' %>" data-dob="<%= cow.dob ? (cow.dob.toISOString ? cow.dob.toISOString().slice(0,10) : new Date(cow.dob).toISOString().slice(0,10)) : '' %>" data-last-calving="<%= cow.lastCalving ? (cow.lastCalving.toISOString ? cow.lastCalving.toISOString().slice(0,10) : new Date(cow.lastCalving).toISOString().slice(0,10)) : '' %>" data-notes="<%- (cow.notes || '').replace(/"/g,'&quot;') %>" data-mother-number="<%= cow.motherCowNumber || '' %>" data-mother-name="<%= cow.motherCowName || '' %>" data-mother-breed="<%= cow.motherCowBreed || '' %>" data-sire-number="<%= cow.sireBullNumber || '' %>" data-sire-name="<%= cow.sireBullName || '' %>" data-sire-breed="<%= cow.sireBullBreed || '' %>">
              <td><a href="/profile/cow/<%= cow._id %>" style="color:#0d6efd;text-decoration:none;"><%= cow.cowNumber %></a></td>
              <td><%= cow.cowName %></td>
              <td><%= cow.race || 'N/A' %></td>
              <td><%= cow.dob ? cow.dob.toDateString() : 'N/A' %></td>
              <td>
                <% if (cow.notes && cow.notes.trim()) { %>
                  <details>
                    <summary>Preview</summary>
                    <div class="notes-content"><%= cow.notes %></div>
                  </details>
                  <button type="button" class="add-button" style="background:#0d6efd" data-type="cow" data-id="<%= cow._id %>" data-notes="<%- cow.notes.replace(/"/g,'&quot;') %>" onclick="openNotesViewer(this)">Open Viewer</button>
                <% } else { %>N/A<% } %>
              </td>
              <td><button class="add-button" style="background:#0d6efd" onclick="toggleMoreInfo('cow','<%= cow._id %>')">More Info</button></td>
              <td class="actions-inline">
                <button class="add-button" style="background:#ffc107;color:#000" onclick="openEditModal('cow','<%= cow._id %>')">Edit</button>
                <button class="add-button" style="background:#dc3545" onclick="confirmDelete('cow','<%= cow._id %>')">Delete</button>
              </td>
            </tr>
            <tr id="cow-more-<%= cow._id %>" class="more-info-row" style="display:none;">
              <td colspan="7">
                <div class="detail-grid">
                  <div><label>Mother #</label><span><% if (cow.motherCowNumber) { %><a href="/profile/cow/number/<%= encodeURIComponent(cow.motherCowNumber) %>" style="color:#0d6efd"><%= cow.motherCowNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Mother Name</label><span><%= cow.motherCowName || 'N/A' %></span></div>
                  <div><label>Mother Breed</label><span><%= cow.motherCowBreed || 'N/A' %></span></div>
                  <div><label>Sire #</label><span><% if (cow.sireBullNumber) { %><a href="/profile/bull/number/<%= encodeURIComponent(cow.sireBullNumber) %>" style="color:#0d6efd"><%= cow.sireBullNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Sire Name</label><span><%= cow.sireBullName || 'N/A' %></span></div>
                  <div><label>Sire Breed</label><span><%= cow.sireBullBreed || 'N/A' %></span></div>
                  <div><label>Last Calving</label><span><%= cow.lastCalving ? cow.lastCalving.toDateString() : 'N/A' %></span></div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Bulls Section -->
  <section id="bulls-section">
    <h2 style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">Bulls
      <button id="add-bull-btn" class="add-button" onclick="openAddModal('bull', false)">Add Bull</button>
      <button id="add-bull-ai-btn" class="add-button" style="background:#6f42c1; display:none;" onclick="openAddModal('bull', true)">Add Insemination Bull</button>
    </h2>
    <div class="bull-tabs">
      <button id="tab-bulls-herd" type="button" class="bull-tab herd active">Herd Bulls</button>
      <button id="tab-bulls-ai" type="button" class="bull-tab ai">Insemination Bulls</button>
    </div>
    <div class="table-container">
      <table id="bulls-herd-table" class="bull-table">
        <thead>
          <tr>
            <th>Bull #</th>
            <th>Name</th>
            <th>Breed</th>
            <th>DOB</th>
            <th>Notes</th>
            <th>More Info</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% bulls.filter(b=>!b.isInsemination).forEach(bull => { %>
            <tr id="bull-row-<%= bull._id %>" class="data-row" data-id="<%= bull._id %>" data-number="<%= bull.bullNumber || '' %>" data-name="<%= bull.bullName || '' %>" data-breed="<%= bull.race || '' %>" data-dob="<%= bull.dob ? (bull.dob.toISOString ? bull.dob.toISOString().slice(0,10) : new Date(bull.dob).toISOString().slice(0,10)) : '' %>" data-notes="<%- (bull.notes || '').replace(/"/g,'&quot;') %>" data-mother-number="<%= bull.motherCowNumber || '' %>" data-mother-name="<%= bull.motherCowName || '' %>" data-mother-breed="<%= bull.motherCowBreed || '' %>" data-sire-number="<%= bull.sireBullNumber || '' %>" data-sire-name="<%= bull.sireBullName || '' %>" data-sire-breed="<%= bull.sireBullBreed || '' %>">
              <td><a href="/profile/bull/<%= bull._id %>" style="color:#0d6efd;text-decoration:none;"><%= bull.bullNumber %></a></td>
              <td><%= bull.bullName %></td>
              <td><%= bull.race || 'N/A' %></td>
              <td><%= bull.dob ? bull.dob.toDateString() : 'N/A' %></td>
              <td>
                <% if (bull.notes && bull.notes.trim()) { %>
                  <details><summary>Preview</summary><div class="notes-content"><%= bull.notes %></div></details>
                  <button type="button" class="add-button" style="background:#0d6efd" data-type="bull" data-id="<%= bull._id %>" data-notes="<%- bull.notes.replace(/"/g,'&quot;') %>" onclick="openNotesViewer(this)">Open Viewer</button>
                <% } else { %>N/A<% } %>
              </td>
              <td><button class="add-button" style="background:#0d6efd" onclick="toggleMoreInfo('bull','<%= bull._id %>')">More Info</button></td>
              <td class="actions-inline">
                <button class="add-button" style="background:#ffc107;color:#000" onclick="openEditModal('bull','<%= bull._id %>')">Edit</button>
                <button class="add-button" style="background:#dc3545" onclick="confirmDelete('bull','<%= bull._id %>')">Delete</button>
              </td>
            </tr>
            <tr id="bull-more-<%= bull._id %>" class="more-info-row" style="display:none;">
              <td colspan="7">
                <div class="detail-grid">
                  <div><label>Mother #</label><span><% if (bull.motherCowNumber) { %><a href="/profile/cow/number/<%= encodeURIComponent(bull.motherCowNumber) %>" style="color:#0d6efd"><%= bull.motherCowNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Mother Name</label><span><%= bull.motherCowName || 'N/A' %></span></div>
                  <div><label>Mother Breed</label><span><%= bull.motherCowBreed || 'N/A' %></span></div>
                  <div><label>Sire #</label><span><% if (bull.sireBullNumber) { %><a href="/profile/bull/number/<%= encodeURIComponent(bull.sireBullNumber) %>" style="color:#0d6efd"><%= bull.sireBullNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Sire Name</label><span><%= bull.sireBullName || 'N/A' %></span></div>
                  <div><label>Sire Breed</label><span><%= bull.sireBullBreed || 'N/A' %></span></div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <!-- Insemination Bulls (AI) -->
      <table id="bulls-ai-table" class="bull-table" style="display:none;">
        <thead>
          <tr>
            <th>Bull #</th>
            <th>Name</th>
            <th>Breed</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% bulls.filter(b=>b.isInsemination).forEach(bull => { %>
            <tr id="bull-row-<%= bull._id %>" class="data-row" data-id="<%= bull._id %>" data-number="<%= bull.bullNumber || '' %>" data-name="<%= bull.bullName || '' %>" data-breed="<%= bull.race || '' %>" data-dob="<%= bull.dob ? (bull.dob.toISOString ? bull.dob.toISOString().slice(0,10) : new Date(bull.dob).toISOString().slice(0,10)) : '' %>" data-notes="<%- (bull.notes || '').replace(/\"/g,'&quot;') %>">
              <td><a href="/profile/bull/<%= bull._id %>" style="color:#6f42c1;text-decoration:none;"><%= bull.bullNumber %></a></td>
              <td><%= bull.bullName %></td>
              <td><%= bull.race || 'N/A' %></td>
              <td>
                <% if (bull.notes && bull.notes.trim()) { %>
                  <details><summary>Preview</summary><div class="notes-content"><%= bull.notes %></div></details>
                  <button type="button" class="add-button" style="background:#6f42c1" data-type="bull" data-id="<%= bull._id %>" data-notes="<%- bull.notes.replace(/"/g,'&quot;') %>" onclick="openNotesViewer(this)">Open Viewer</button>
                <% } else { %>N/A<% } %>
              </td>
              <td class="actions-inline">
                <button class="add-button" style="background:#ffc107;color:#000" onclick="openEditModal('bull','<%= bull._id %>')">Edit</button>
                <button class="add-button" style="background:#dc3545" onclick="confirmDelete('bull','<%= bull._id %>')">Delete</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Calves Section -->
  <section id="calves-section">
    <h2>Calves <button class="add-button" onclick="openAddModal('calf')">Add Calf</button></h2>
    <div class="table-container">
      <table class="calf-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Breed</th>
            <th>DOB</th>
            <th>Gender</th>
            <th>Notes</th>
            <th>More Info</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% calves.forEach(calf => { %>
            <tr id="calf-row-<%= calf._id %>" class="data-row" data-id="<%= calf._id %>" data-name="<%= calf.calfName || '' %>" data-breed="<%= calf.calfBreed || '' %>" data-dob="<%= calf.birthDate ? (calf.birthDate.toISOString ? calf.birthDate.toISOString().slice(0,10) : new Date(calf.birthDate).toISOString().slice(0,10)) : '' %>" data-gender="<%= calf.gender || '' %>" data-notes="<%- (calf.notes || '').replace(/"/g,'&quot;') %>" data-mother-number="<%= calf.motherCowNumber || '' %>" data-mother-name="<%= calf.motherCowName || '' %>" data-mother-breed="<%= calf.motherCowBreed || '' %>" data-sire-number="<%= calf.sireBullNumber || '' %>" data-sire-name="<%= calf.sireBullName || '' %>" data-sire-breed="<%= calf.sireBullBreed || '' %>">
              <td><a href="/profile/calf/<%= calf._id %>" style="color:#0d6efd;text-decoration:none;"><%= calf.calfName || 'Unnamed Calf' %></a></td>
              <td><%= calf.calfBreed || 'N/A' %></td>
              <td><%= calf.birthDate ? calf.birthDate.toDateString() : 'N/A' %></td>
              <td><%= calf.gender || 'N/A' %></td>
              <td>
                <% if (calf.notes && calf.notes.trim()) { %>
                  <details><summary>Preview</summary><div class="notes-content"><%= calf.notes %></div></details>
                  <button type="button" class="add-button" style="background:#0d6efd" data-type="calf" data-id="<%= calf._id %>" data-notes="<%- calf.notes.replace(/"/g,'&quot;') %>" onclick="openNotesViewer(this)">Open Viewer</button>
                <% } else { %>N/A<% } %>
              </td>
              <td><button class="add-button" style="background:#0d6efd" onclick="toggleMoreInfo('calf','<%= calf._id %>')">More Info</button></td>
              <td class="actions-inline">
                <button class="add-button" style="background:#ffc107;color:#000" onclick="openEditModal('calf','<%= calf._id %>')">Edit</button>
                <button class="add-button" style="background:#dc3545" onclick="confirmDelete('calf','<%= calf._id %>')">Delete</button>
              </td>
            </tr>
            <tr id="calf-more-<%= calf._id %>" class="more-info-row" style="display:none;">
              <td colspan="7">
                <div class="detail-grid">
                  <div><label>Mother #</label><span><% if (calf.motherCowNumber) { %><a href="/profile/cow/number/<%= encodeURIComponent(calf.motherCowNumber) %>" style="color:#0d6efd"><%= calf.motherCowNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Mother Name</label><span><%= calf.motherCowName || 'N/A' %></span></div>
                  <div><label>Mother Breed</label><span><%= calf.motherCowBreed || 'N/A' %></span></div>
                  <div><label>Sire #</label><span><% if (calf.sireBullNumber) { %><a href="/profile/bull/number/<%= encodeURIComponent(calf.sireBullNumber) %>" style="color:#0d6efd"><%= calf.sireBullNumber %></a><% } else { %>N/A<% } %></span></div>
                  <div><label>Sire Name</label><span><%= calf.sireBullName || 'N/A' %></span></div>
                  <div><label>Sire Breed</label><span><%= calf.sireBullBreed || 'N/A' %></span></div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Add/Edit Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modal-title">Add</h2>
      <form id="modal-form"></form>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfirmModal()">&times;</span>
      <h2 id="confirm-title">Confirm</h2>
      <div id="confirm-body"></div>
      <div style="margin-top:12px;text-align:right;">
        <button id="confirm-yes" class="add-button" style="background:#dc3545">Confirm</button>
        <button type="button" class="add-button" style="background:#6c757d" onclick="closeConfirmModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Notes Viewer Modal -->
  <div id="notes-viewer-modal" class="modal">
    <div class="modal-content" style="max-width:480px;">
      <span class="close" onclick="closeNotesViewer()">&times;</span>
      <h2 style="margin-top:0;">Notes Viewer</h2>
      <textarea id="notes-viewer-textarea" rows="12" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:0.8rem; resize:vertical;"></textarea>
      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <small style="color:#6c757d;">Edit notes and click Save to persist.</small>
        <div style="text-align:right; display:flex; gap:8px;">
          <button type="button" class="add-button" style="background:#198754" onclick="saveNotesFromViewer()">Save</button>
          <button type="button" class="add-button" style="background:#6c757d" onclick="closeNotesViewer()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
      // Smooth scroll to a section by id
      function scrollToSection(id){
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      // Sidebar toggle (match behavior from other pages)
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger');
      const closeSidebarEls = document.querySelectorAll('.close-sidebar');
      if (hamburger) {
        hamburger.addEventListener('click', () => {
          sidebar.classList.toggle('open');
        });
      }
      closeSidebarEls.forEach(btn => btn.addEventListener('click', () => sidebar.classList.remove('open')));
      document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
          sidebar.classList.remove('open');
        }
      });

      // Modal and form handling
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const modalForm = document.getElementById('modal-form');

      function openAddModal(type, isAI) {
        modal.style.display = 'block';
        const ai = !!isAI;
        modalTitle.textContent = `Add ${ai && type==='bull' ? 'Insemination Bull' : (type.charAt(0).toUpperCase() + type.slice(1))}`;
        // Mark form mode so submit handler knows we're adding
        modalForm.dataset.mode = 'add';

        let formFields = '';
        if (type === 'cow') {
          formFields = `
            <div class="form-grid">
              <label>Cow Number:</label><input id="registeringNumber" name="registeringNumber" required>
              <label>Cow Name:</label><input name="registeringName" required>
              <label>Cow Breed:</label><input name="registeringRace" required>
              <label>DOB:</label><input type="date" name="dob">
              <label>Last Calving:</label><input type="date" name="lastCalving">
              <label>Notes:</label><textarea name="notes" rows="3"></textarea>
              <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" oninput="autoFillParent('cow','motherCowNumber')">
              <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
              <input type="hidden" name="motherCowName"><input type="hidden" name="motherCowBreed">
              <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" oninput="autoFillParent('bull','sireBullNumber')">
              <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
              <input type="hidden" name="sireBullName"><input type="hidden" name="sireBullBreed">
            </div>`;
        } else if (type === 'bull') {
          if (ai) {
            formFields = `
              <div class="form-grid">
                <label>Bull Number:</label><input id="registeringNumber" name="registeringNumber" required>
                <label>Bull Name:</label><input name="registeringName" required>
                <label>Bull Breed:</label><input name="registeringRace" required>
                <label>Notes:</label><textarea name="notes" rows="3"></textarea>
              </div>
              <input type="hidden" name="isInsemination" value="true">`;
          } else {
            formFields = `
              <div class="form-grid">
                <label>Bull Number:</label><input id="registeringNumber" name="registeringNumber" required>
                <label>Bull Name:</label><input name="registeringName" required>
                <label>Bull Breed:</label><input name="registeringRace" required>
                <label>DOB:</label><input type="date" name="dob">
                <label>Notes:</label><textarea name="notes" rows="3"></textarea>
                <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" oninput="autoFillParent('cow','motherCowNumber')">
                <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
                <input type="hidden" name="motherCowName"><input type="hidden" name="motherCowBreed">
                <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" oninput="autoFillParent('bull','sireBullNumber')">
                <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
                <input type="hidden" name="sireBullName"><input type="hidden" name="sireBullBreed">
              </div>`;
          }
        } else if (type === 'calf') {
          formFields = `
            <div class="form-grid">
              <label>Calf Name:</label><input name="calfName" required>
              <label>Calf Breed:</label><input name="calfBreed" required>
              <label>DOB:</label><input type="date" name="birthDate" required>
              <label>Gender:</label><select name="gender" required><option value="" disabled selected>Select</option><option value="male">Male</option><option value="female">Female</option></select>
              <label>Notes:</label><textarea name="notes" rows="3"></textarea>
              <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" oninput="autoFillParent('cow','motherCowNumber')">
              <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
              <input type="hidden" name="motherCowName"><input type="hidden" name="motherCowBreed">
              <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" oninput="autoFillParent('bull','sireBullNumber')">
              <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Enter number to auto-fill</span>
              <input type="hidden" name="sireBullName"><input type="hidden" name="sireBullBreed">
            </div>`;
        }

        modalForm.innerHTML = `<input type="hidden" name="type" value="${type}">` + formFields + `<div style="margin-top:12px;text-align:right;"><button type="submit" class="add-button" style="background:#198754">Save</button><button type="button" class="add-button" style="background:#6c757d" onclick="closeModal()">Cancel</button></div>`;
        clearFieldErrors();
        addRealtimeValidationHandlers();
      }

      // Separate helper for closing temporary popup modals to avoid
      // colliding with the main modal's closeModal() above
      function closePopup(modalEl) {
        if (!modalEl) return;
        modalEl.style.display = 'none';
        if (modalEl.parentElement) {
          document.body.removeChild(modalEl);
        }
      }

      function deleteEntry(type, id, modal) {
        fetch('/delete-cattle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ type, id }),
        })
          .then(response => {
            if (response.ok) {
              showCustomPopup('Entry deleted successfully!', 'success');
              // Give the toast time to show before reload
              setTimeout(() => location.reload(), 1200);
            } else {
              response.text().then(error => {
                throw new Error(error);
              });
            }
          })
          .catch(err => {
            console.error('Error deleting entry:', err);
            showCustomPopup('An error occurred while deleting the entry.', 'error');
          })
          .finally(() => {
            closePopup(modal);
          });
      }

      function confirmDelete(type, id) {
        const body = `<p>Are you sure you want to delete this ${type}?</p>`;
        openConfirmModal('Confirm Deletion', body, () => {
          deleteEntry(type, id, null);
          closeConfirmModal();
        }, { label: 'Yes, Delete', variant: 'danger' });
      }

      // Fix close button functionality for modals
      const closeButtons = document.querySelectorAll('.modal .close');
      closeButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Always close the main modal
          closeModal();
        });
      });


      function addSearchBar(type) {
        const table = document.querySelector(`.${type}-table`);
        if (!table) return;
        const container = document.createElement('div');
        container.className = 'search-container';

        // Quick search controls
        const actions = document.createElement('div');
        actions.className = 'search-actions';
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = `Quick search ${type}s...`;
        const columnSelector = document.createElement('select');
        const headers = table.querySelectorAll('thead th');
        headers.forEach((header, index) => {
          const text = header.textContent.trim().toLowerCase();
          if (text !== 'actions' && text !== 'more info') {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = header.textContent;
            columnSelector.appendChild(option);
          }
        });
  const advBtn = document.createElement('button');
  advBtn.type = 'button';
  advBtn.textContent = 'Advanced Filters';
  advBtn.className = 'add-button advanced-filter-btn';

        actions.appendChild(searchInput);
        actions.appendChild(columnSelector);
        actions.appendChild(advBtn);

        // Advanced panel
        const advPanel = document.createElement('div');
        advPanel.className = 'advanced-panel';
        advPanel.innerHTML = buildAdvancedFields(type);

        const applyBtn = document.createElement('button');
        applyBtn.type = 'button';
        applyBtn.textContent = 'Apply';
        applyBtn.className = 'add-button';
        applyBtn.style.background = '#198754';
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.textContent = 'Clear';
        clearBtn.className = 'add-button';
        clearBtn.style.background = '#6c757d';

        const advActions = document.createElement('div');
        advActions.className = 'search-actions';
        advActions.style.marginTop = '8px';
        advActions.appendChild(applyBtn);
        advActions.appendChild(clearBtn);
        advPanel.appendChild(advActions);

        container.appendChild(actions);
        container.appendChild(advPanel);

        // Wire events
        searchInput.addEventListener('input', () => filterRows(type, { query: searchInput.value, columnIndex: columnSelector.value }));
        columnSelector.addEventListener('change', () => filterRows(type, { query: searchInput.value, columnIndex: columnSelector.value }));
        advBtn.addEventListener('click', () => { advPanel.style.display = advPanel.style.display === 'none' || !advPanel.style.display ? 'block' : 'none'; });
        applyBtn.addEventListener('click', () => filterRows(type, { query: searchInput.value, columnIndex: columnSelector.value }));
        clearBtn.addEventListener('click', () => {
          advPanel.querySelectorAll('input,select').forEach(el => { if (el.type === 'date' || el.tagName === 'SELECT' || el.type === 'text') el.value = ''; });
          filterRows(type, { query: searchInput.value = '', columnIndex: columnSelector.value });
        });

        // Insert above the table container
        table.parentElement.parentElement.insertBefore(container, table.parentElement);
      }

      function buildAdvancedFields(type) {
        const commonLineage = `
          <label>Mother #<input name="motherNumber" type="text"></label>
          <label>Mother Name<input name="motherName" type="text"></label>
          <label>Mother Breed<input name="motherBreed" type="text"></label>
          <label>Sire #<input name="sireNumber" type="text"></label>
          <label>Sire Name<input name="sireName" type="text"></label>
          <label>Sire Breed<input name="sireBreed" type="text"></label>
        `;
        if (type === 'cow') {
          return `
            <div class="advanced-grid">
              <label>Number<input name="number" type="text"></label>
              <label>Name<input name="name" type="text"></label>
              <label>Breed<input name="breed" type="text"></label>
              <label>DOB From<input name="dobFrom" type="date"></label>
              <label>DOB To<input name="dobTo" type="date"></label>
              <label>Last Calving From<input name="lcFrom" type="date"></label>
              <label>Last Calving To<input name="lcTo" type="date"></label>
              <label>Notes Contains<input name="notes" type="text"></label>
              ${commonLineage}
            </div>
          `;
        } else if (type === 'calf') {
          return `
            <div class="advanced-grid">
              <label>Name<input name="name" type="text"></label>
              <label>Breed<input name="breed" type="text"></label>
              <label>Gender<select name="gender"><option value="">Any</option><option value="male">Male</option><option value="female">Female</option></select></label>
              <label>DOB From<input name="dobFrom" type="date"></label>
              <label>DOB To<input name="dobTo" type="date"></label>
              <label>Notes Contains<input name="notes" type="text"></label>
              ${commonLineage}
            </div>
          `;
        } else {
          return `
            <div class="advanced-grid">
              <label>Number<input name="number" type="text"></label>
              <label>Name<input name="name" type="text"></label>
              <label>Breed<input name="breed" type="text"></label>
              <label>DOB From<input name="dobFrom" type="date"></label>
              <label>DOB To<input name="dobTo" type="date"></label>
              <label>Notes Contains<input name="notes" type="text"></label>
              ${commonLineage}
            </div>
          `;
        }
      }

      function filterRows(type, opts) {
        const table = document.querySelector(`.${type}-table`);
        const advPanel = table.parentElement.previousSibling.querySelector('.advanced-panel');
        const adv = {};
        advPanel.querySelectorAll('input,select').forEach(el => adv[el.name] = (el.value || '').trim().toLowerCase());
        const query = (opts.query || '').trim().toLowerCase();
        const colIdx = Number(opts.columnIndex || 0);
        const rows = table.querySelectorAll('tbody tr.data-row');
        rows.forEach(row => {
          const cells = row.cells;
          const basicCell = cells[colIdx];
          let ok = true;
          // Basic
          if (query) {
            const cellText = (basicCell ? basicCell.textContent : '').trim().toLowerCase();
            ok = cellText && cellText !== 'n/a' && cellText.includes(query);
          }
          // Advanced
          if (ok) {
            const ds = row.dataset;
            const name = (ds.name || '').toLowerCase();
            const number = (ds.number || '').toLowerCase();
            const breed = (ds.breed || '').toLowerCase();
            const gender = (ds.gender || '').toLowerCase();
            const dob = ds.dob || '';
            const lastCalving = ds.lastCalving || '';
            const notes = (ds.notes || '').toLowerCase();
            const motherNumber = (ds.motherNumber || '').toLowerCase();
            const motherName = (ds.motherName || '').toLowerCase();
            const motherBreed = (ds.motherBreed || '').toLowerCase();
            const sireNumber = (ds.sireNumber || '').toLowerCase();
            const sireName = (ds.sireName || '').toLowerCase();
            const sireBreed = (ds.sireBreed || '').toLowerCase();

            if (adv.name && !name.includes(adv.name)) ok = false;
            if (adv.number && !number.includes(adv.number)) ok = false;
            if (adv.breed && !breed.includes(adv.breed)) ok = false;
            if (adv.gender && type === 'calf' && adv.gender !== gender) ok = false;
            if (adv.notes && !notes.includes(adv.notes)) ok = false;
            if (adv.motherNumber && !motherNumber.includes(adv.motherNumber)) ok = false;
            if (adv.motherName && !motherName.includes(adv.motherName)) ok = false;
            if (adv.motherBreed && !motherBreed.includes(adv.motherBreed)) ok = false;
            if (adv.sireNumber && !sireNumber.includes(adv.sireNumber)) ok = false;
            if (adv.sireName && !sireName.includes(adv.sireName)) ok = false;
            if (adv.sireBreed && !sireBreed.includes(adv.sireBreed)) ok = false;

            // Date ranges
            const inRange = (val, from, to) => {
              if (!from && !to) return true;
              if (!val) return false;
              if (from && val < from) return false;
              if (to && val > to) return false;
              return true;
            };

            const dobFrom = adv.dobFrom || '';
            const dobTo = adv.dobTo || '';
            if (type !== 'cow') {
              // for calves/bulls, use dob
              if (!inRange(dob, dobFrom, dobTo)) ok = false;
            } else {
              if (!inRange(dob, dobFrom, dobTo)) ok = false;
              const lcFrom = adv.lcFrom || '';
              const lcTo = adv.lcTo || '';
              if (!inRange(lastCalving, lcFrom, lcTo)) ok = false;
            }
          }

        // apply
          row.style.display = ok ? '' : 'none';
          const id = row.querySelector('td:last-child button')?.getAttribute('onclick') || '';
          // Fallback to using row id presence
          const moreRow = (() => {
            const btn = row.querySelector('button[onclick^="toggleMoreInfo("]');
            if (btn) {
              const m = btn.getAttribute('onclick').match(/toggleMoreInfo\('\w+',\s*'([a-f0-9]+)'\)/i);
              if (m) return document.getElementById(`${type}-more-${m[1]}`);
            }
            return null;
          })();
          if (moreRow) moreRow.style.display = ok ? moreRow.style.display : 'none';
        });
      }

  ['cow', 'bull', 'calf'].forEach(type => addSearchBar(type));

      // Bulls tab toggle for Herd vs Insemination
      (function setupBullTabs(){
        const herdBtn = document.getElementById('tab-bulls-herd');
        const aiBtn = document.getElementById('tab-bulls-ai');
        const herdTable = document.getElementById('bulls-herd-table');
        const aiTable = document.getElementById('bulls-ai-table');
        const addBullBtn = document.getElementById('add-bull-btn');
        const addAIBtn = document.getElementById('add-bull-ai-btn');
        if (!herdBtn || !aiBtn || !herdTable || !aiTable) return;
        function activate(which){
          const herdActive = which === 'herd';
          herdTable.style.display = herdActive ? '' : 'none';
          aiTable.style.display = herdActive ? 'none' : '';
          herdBtn.classList.toggle('active', herdActive);
          aiBtn.classList.toggle('active', !herdActive);
          if (addBullBtn) addBullBtn.style.display = herdActive ? '' : 'none';
          if (addAIBtn) addAIBtn.style.display = herdActive ? 'none' : '';
        }
        herdBtn.addEventListener('click', ()=> activate('herd'));
        aiBtn.addEventListener('click', ()=> activate('ai'));
        activate('herd');
      })();

      function openEditModal(type, id) {
        modal.style.display = 'block';
        modalTitle.textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        // Mark form mode so submit handler knows we're editing
        modalForm.dataset.mode = 'edit';

        // Show loading state while fetching
        modalForm.innerHTML = '<div style="padding:10px;font-size:.85rem;color:#6c757d;">Loading...</div>';
        fetch(`/get-cattle?id=${id}&type=${type}`)
          .then(async response => {
            if (!response.ok) {
              const txt = await response.text();
              throw new Error(txt || 'Failed to fetch cattle data');
            }
            return response.json();
          })
          .then(data => {
            if (!data || data.error) {
              showCustomPopup(data && data.error ? data.error : 'Entry not found', 'error');
              modalForm.innerHTML = '<div style="padding:10px;color:#dc3545;">Entry not found.</div>';
              return;
            }
            const fmt = (d) => (d ? new Date(d).toISOString().slice(0, 10) : '');
            let formFields = '';

            if (type === 'cow') {
              formFields = `
                <div class="form-grid">
                  <label>Cow Number:</label><input id="registeringNumber" name="registeringNumber" value="${data.cowNumber || ''}" required>
                  <label>Cow Name:</label><input name="registeringName" value="${data.cowName || ''}" required>
                  <label>Cow Breed:</label><input name="registeringRace" value="${data.race || ''}" required>
                  <label>DOB:</label><input type="date" name="dob" value="${fmt(data.dob)}">
                  <label>Last Calving:</label><input type="date" name="lastCalving" value="${fmt(data.lastCalving)}">
                  <label>Notes:</label><textarea name="notes" rows="3">${data.notes || ''}</textarea>
                  <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" value="${data.motherCowNumber || ''}" oninput="autoFillParent('cow','motherCowNumber')">
                  <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                  <input type="hidden" name="motherCowName" value="${data.motherCowName || ''}"><input type="hidden" name="motherCowBreed" value="${data.motherCowBreed || ''}">
                  <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" value="${data.sireBullNumber || ''}" oninput="autoFillParent('bull','sireBullNumber')">
                  <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                  <input type="hidden" name="sireBullName" value="${data.sireBullName || ''}"><input type="hidden" name="sireBullBreed" value="${data.sireBullBreed || ''}">
                </div>`;
            } else if (type === 'bull') {
              if (data.isInsemination) {
                formFields = `
                  <div class="form-grid">
                    <label>Bull Number:</label><input id="registeringNumber" name="registeringNumber" value="${data.bullNumber || ''}" required>
                    <label>Bull Name:</label><input name="registeringName" value="${data.bullName || ''}" required>
                    <label>Bull Breed:</label><input name="registeringRace" value="${data.race || ''}" required>
                    <label>Notes:</label><textarea name="notes" rows="3">${data.notes || ''}</textarea>
                  </div>
                  <input type="hidden" name="isInsemination" value="true">`;
              } else {
                formFields = `
                  <div class="form-grid">
                    <label>Bull Number:</label><input id="registeringNumber" name="registeringNumber" value="${data.bullNumber || ''}" required>
                    <label>Bull Name:</label><input name="registeringName" value="${data.bullName || ''}" required>
                    <label>Bull Breed:</label><input name="registeringRace" value="${data.race || ''}" required>
                    <label>DOB:</label><input type="date" name="dob" value="${fmt(data.dob)}">
                    <label>Notes:</label><textarea name="notes" rows="3">${data.notes || ''}</textarea>
                    <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" value="${data.motherCowNumber || ''}" oninput="autoFillParent('cow','motherCowNumber')">
                    <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                    <input type="hidden" name="motherCowName" value="${data.motherCowName || ''}"><input type="hidden" name="motherCowBreed" value="${data.motherCowBreed || ''}">
                    <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" value="${data.sireBullNumber || ''}" oninput="autoFillParent('bull','sireBullNumber')">
                    <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                    <input type="hidden" name="sireBullName" value="${data.sireBullName || ''}"><input type="hidden" name="sireBullBreed" value="${data.sireBullBreed || ''}">
                  </div>
                  <div style="margin-top:8px; font-size:.85rem;">
                    <label style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
                      <input type="checkbox" id="isInseminationChk"> Mark as Insemination Bull (no parents)
                    </label>
                  </div>`;
              }
            } else if (type === 'calf') {
              formFields = `
                <div class="form-grid">
                  <label>Calf Name:</label><input name="calfName" value="${data.calfName || ''}" required>
                  <label>Calf Breed:</label><input name="calfBreed" value="${data.calfBreed || ''}" required>
                  <label>DOB:</label><input type="date" name="birthDate" value="${fmt(data.birthDate)}" required>
                  <label>Gender:</label><select name="gender" required><option value="male" ${data.gender==='male'?'selected':''}>Male</option><option value="female" ${data.gender==='female'?'selected':''}>Female</option></select>
                  <label>Notes:</label><textarea name="notes" rows="3">${data.notes || ''}</textarea>
                  <label>Mother Cow #:</label><input id="motherCowNumber" name="motherCowNumber" value="${data.motherCowNumber || ''}" oninput="autoFillParent('cow','motherCowNumber')">
                  <span class="parent-meta" id="motherCowNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                  <input type="hidden" name="motherCowName" value="${data.motherCowName || ''}"><input type="hidden" name="motherCowBreed" value="${data.motherCowBreed || ''}">
                  <label>Sire Bull #:</label><input id="sireBullNumber" name="sireBullNumber" value="${data.sireBullNumber || ''}" oninput="autoFillParent('bull','sireBullNumber')">
                  <span class="parent-meta" id="sireBullNumber_meta" style="grid-column:1 / -1;">Auto-fill</span>
                  <input type="hidden" name="sireBullName" value="${data.sireBullName || ''}"><input type="hidden" name="sireBullBreed" value="${data.sireBullBreed || ''}">
                </div>`;
            }

            modalForm.innerHTML = `<input type="hidden" name="type" value="${type}"><input type="hidden" name="id" value="${id}">` + formFields + `<div style="margin-top:12px;text-align:right;"><button type="submit" class="add-button" style="background:#198754">Save</button><button type="button" class="add-button" style="background:#6c757d" onclick="closeModal()">Cancel</button></div>`;
            clearFieldErrors();
            addRealtimeValidationHandlers();
            // Autofill existing parent numbers immediately
            if (data.motherCowNumber) autoFillParent('cow','motherCowNumber');
            if (data.sireBullNumber) autoFillParent('bull','sireBullNumber');
            // Wire conversion toggle for bulls
            if (type === 'bull' && !data.isInsemination) {
              const chk = document.getElementById('isInseminationChk');
              if (chk) {
                chk.addEventListener('change', (e)=>{
                  const on = e.target.checked;
                  const mc = document.getElementById('motherCowNumber');
                  const sc = document.getElementById('sireBullNumber');
                  if (on) {
                    // Clear and disable parent fields
                    if (mc) { mc.value=''; mc.disabled=true; }
                    if (sc) { sc.value=''; sc.disabled=true; }
                    // Inject hidden field
                    let h = modalForm.querySelector('input[name="isInsemination"]');
                    if (!h) { h = document.createElement('input'); h.type='hidden'; h.name='isInsemination'; modalForm.appendChild(h); }
                    h.value = 'true';
                  } else {
                    if (mc) mc.disabled=false;
                    if (sc) sc.disabled=false;
                    const h = modalForm.querySelector('input[name="isInsemination"]');
                    if (h) h.remove();
                  }
                });
              }
            }
            // Keep original for diffing using exact form field names per type
            if (type === 'cow') {
              window._currentEditOriginal = {
                type, id,
                registeringNumber: data.cowNumber || '',
                registeringName: data.cowName || '',
                registeringRace: data.race || '',
                dob: fmt(data.dob),
                lastCalving: fmt(data.lastCalving),
                notes: data.notes || '',
                motherCowNumber: data.motherCowNumber || '',
                motherCowName: data.motherCowName || '',
                motherCowBreed: data.motherCowBreed || '',
                sireBullNumber: data.sireBullNumber || '',
                sireBullName: data.sireBullName || '',
                sireBullBreed: data.sireBullBreed || '',
              };
            } else if (type === 'calf') {
              window._currentEditOriginal = {
                type, id,
                calfName: data.calfName || '',
                calfBreed: data.calfBreed || '',
                birthDate: fmt(data.birthDate),
                gender: data.gender || '',
                notes: data.notes || '',
                motherCowNumber: data.motherCowNumber || '',
                motherCowName: data.motherCowName || '',
                motherCowBreed: data.motherCowBreed || '',
                sireBullNumber: data.sireBullNumber || '',
                sireBullName: data.sireBullName || '',
                sireBullBreed: data.sireBullBreed || '',
              };
            } else if (type === 'bull') {
              window._currentEditOriginal = {
                type, id,
                registeringNumber: data.bullNumber || '',
                registeringName: data.bullName || '',
                registeringRace: data.race || '',
                dob: fmt(data.dob),
                notes: data.notes || '',
                motherCowNumber: data.isInsemination ? '' : (data.motherCowNumber || ''),
                motherCowName: data.isInsemination ? '' : (data.motherCowName || ''),
                motherCowBreed: data.isInsemination ? '' : (data.motherCowBreed || ''),
                sireBullNumber: data.isInsemination ? '' : (data.sireBullNumber || ''),
                sireBullName: data.isInsemination ? '' : (data.sireBullName || ''),
                sireBullBreed: data.isInsemination ? '' : (data.sireBullBreed || ''),
              };
            }
          })
          .catch(err => {
            console.error('Error fetching entry data:', err);
            showCustomPopup('An error occurred while fetching entry data.', 'error');
            modalForm.innerHTML = '<div style="padding:10px;color:#dc3545;">Failed to load entry.</div>';
          });
      }

      // Toggle helper for "More info"
      function toggleMoreInfo(type, id) {
        const row = document.getElementById(`${type}-more-${id}`);
        if (!row) return;
        row.style.display = row.style.display === 'none' ? '' : 'none';
      }

      // Toasts (in-site notifications)
      function showCustomPopup(message, type) {
        const toast = document.getElementById('toast');
        const item = document.createElement('div');
        item.className = `toast-item ${type || 'info'}`;
        item.textContent = message;
        item.style.transition = 'opacity .35s ease, transform .35s ease';
        item.style.opacity = '0';
        item.style.transform = 'translateY(8px)';
        toast.appendChild(item);
        toast.style.display = 'block';
        requestAnimationFrame(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        });
        const lifetime = (type === 'error') ? 2600 : 1400; // shorter for success/info
        setTimeout(() => {
          item.style.opacity = '0';
          item.style.transform = 'translateY(8px)';
          setTimeout(() => {
            if (item.parentNode === toast) toast.removeChild(item);
            if (!toast.children.length) toast.style.display = 'none';
          }, 350);
        }, lifetime);
      }

      function closeModal() {
        modal.style.display = 'none';
        modalForm.innerHTML = '';
        delete modalForm.dataset.mode;
      }

      // Intercept form submit for Add/Edit flows
      modalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(modalForm);
        const data = Object.fromEntries(formData.entries());
        const mode = modalForm.dataset.mode || 'add';
        const type = data.type;
        try {
          clearFormError();
          clearFieldErrors();
          // If editing, compute diffs and ask for confirmation
          if (mode === 'edit' && window._currentEditOriginal) {
            const original = window._currentEditOriginal;
            const displayMap = {
              registeringNumber: 'Number',
              registeringName: 'Name',
              registeringRace: 'Breed',
              calfName: 'Name',
              calfBreed: 'Breed',
              birthDate: 'DOB',
              dob: 'DOB',
              lastCalving: 'Last Calving',
              notes: 'Notes',
              motherCowNumber: 'Mother #',
              motherCowName: 'Mother Name',
              motherCowBreed: 'Mother Breed',
              sireBullNumber: 'Sire #',
              sireBullName: 'Sire Name',
              sireBullBreed: 'Sire Breed',
              gender: 'Gender'
            };
            const diff = [];
            Object.keys(data).forEach(k => {
              if (k === 'type' || k === 'id') return;
              const newVal = (data[k] || '').trim();
              const oldVal = (original[k] || '').trim();
              if (newVal !== oldVal) diff.push({ key: k, label: displayMap[k] || k, from: oldVal || '', to: newVal || '' });
            });
            if (!diff.length) {
              showCustomPopup('No changes to save.', 'info');
              return;
            }
            const rows = diff.map(d => `<tr><td>${escapeHtml(d.label)}</td><td>${escapeHtml(d.from)}</td><td style=\"width:28px;text-align:center;\"></td><td>${escapeHtml(d.to)}</td></tr>`).join('');
            openConfirmModal('Confirm Changes', `<p>Please review the changes:</p><table style=\"width:100%;border-collapse:collapse;font-size:0.9rem;\"><thead><tr><th style=\"text-align:left;border-bottom:1px solid #ccc;\">Field</th><th style=\"text-align:left;border-bottom:1px solid #ccc;\">Old</th><th style=\"border-bottom:1px solid #ccc;\"></th><th style=\"text-align:left;border-bottom:1px solid #ccc;\">New</th></tr></thead><tbody>${rows}</tbody></table>`, async () => {
              await performSave(mode, type, data);
              closeConfirmModal();
            }, { label: 'Save Changes', variant: 'success' });
            return; // wait for confirmation
          }
          await performSave(mode, type, data);
        } catch (err) {
          console.error(err);
          // Also surface near the form fields
          setFormError(String(err.message || err));
          showCustomPopup(String(err.message || err), 'error');
        }
      });

      function escapeHtml(str){
        return String(str).replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
      }

      async function performSave(mode, type, data){
        if (mode === 'add') {
          try { validateParentsBeforeSave(); } catch(e){ setFormError(e.message); return; }
          const resp = await fetch('/add-cattle', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!resp.ok) {
            const txt = await resp.text();
            let msg = txt; try { const j = JSON.parse(txt); msg = j.error || txt; } catch {}
            handleFieldConflicts(type, msg);
            throw new Error(msg || 'Add failed');
          }
          showCustomPopup('Saved successfully.', 'success');
          closeModal();
          setTimeout(() => location.reload(), 1200);
        } else {
          try { validateParentsBeforeSave(); } catch(e){ setFormError(e.message); return; }
          const id = data.id; delete data.id;
          const resp = await fetch('/edit-cattle', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, type, updates: data })
          });
          if (!resp.ok) {
            const txt = await resp.text();
            handleFieldConflicts(type, txt);
            throw new Error(txt || 'Update failed');
          }
          // Post-edit concise diff summary in toast
          if (window._currentEditOriginal){
            const original = window._currentEditOriginal;
            const changed = [];
            Object.keys(data).forEach(k => {
              if (k==='type') return;
              const nv = (data[k]||'').trim();
              const ov = (original[k]||'').trim();
              if (nv !== ov) changed.push(k);
            });
            if (changed.length) showCustomPopup('Updated: ' + changed.join(', '), 'success');
            else showCustomPopup('Saved successfully.', 'success');
          } else {
            showCustomPopup('Saved successfully.', 'success');
          }
          closeModal();
          setTimeout(() => location.reload(), 1200);
        }
      }

      // Parent autofill + type validation
      async function autoFillParent(parentType, fieldName){
        try {
          const input = document.getElementById(fieldName);
          if(!input) return;
          const val = input.value.trim();
          const meta = document.getElementById(fieldName + '_meta');
          if(!val){
            if(meta) meta.textContent='Enter number to auto-fill';
            input.classList.remove('invalid');
            return;
          }
          if(meta) meta.textContent='Looking up...';
          input.classList.remove('invalid');
          // Generic lookup to detect presence and type
          const rAny = await fetch(`/lookup/number/${encodeURIComponent(val)}`);
          if (rAny.status === 404) {
            if(meta) meta.textContent='Not found';
            input.classList.add('invalid');
            markInvalid(input, 'Number not found');
            return;
          }
          const any = await rAny.json();
          if (any.type !== parentType) {
            if(meta) meta.textContent = `Found ${any.type}, expected ${parentType}`;
            input.classList.add('invalid');
            markInvalid(input, `Wrong type: expected ${parentType}`);
            return;
          }
          // Correct type, fill hidden fields
          if(parentType==='cow'){
            const nameEl = document.querySelector('input[name="motherCowName"]');
            const breedEl = document.querySelector('input[name="motherCowBreed"]');
            if(nameEl) nameEl.value = any.name || '';
            if(breedEl) breedEl.value = any.breed || '';
            if(meta) meta.textContent = `Dam: ${any.name||''} (${any.breed||''})`;
          } else {
            const nameEl = document.querySelector('input[name="sireBullName"]');
            const breedEl = document.querySelector('input[name="sireBullBreed"]');
            if(nameEl) nameEl.value = any.name || '';
            if(breedEl) breedEl.value = any.breed || '';
            if(meta) meta.textContent = `Sire: ${any.name||''} (${any.breed||''})`;
          }
        } catch(e){
          const meta = document.getElementById(fieldName + '_meta');
          if(meta) meta.textContent='Lookup error';
        }
      }

      // Block submit if invalid parent fields
      function validateParentsBeforeSave(){
        const mother = document.getElementById('motherCowNumber');
        const sire = document.getElementById('sireBullNumber');
        if (mother && mother.value.trim() && mother.classList.contains('invalid')) {
          throw new Error('Mother cow number is invalid');
        }
        if (sire && sire.value.trim() && sire.classList.contains('invalid')) {
          throw new Error('Sire bull number is invalid');
        }
      }

      function setFormError(message) {
        if (!modalForm) return;
        let banner = modalForm.querySelector('.error-banner');
        if (!banner) {
          banner = document.createElement('div');
          banner.className = 'error-banner';
          modalForm.insertBefore(banner, modalForm.firstChild);
        }
        banner.textContent = message;
      }

      function clearFormError() {
        if (!modalForm) return;
        const banner = modalForm.querySelector('.error-banner');
        if (banner) banner.remove();
      }

      function markInvalid(inputEl, message) {
        if (!inputEl) return;
        inputEl.classList.add('invalid');
        // Avoid duplicate helper
        let helper = inputEl.parentElement && inputEl.parentElement.querySelector('.error-text');
        if (!helper) {
          helper = document.createElement('span');
          helper.className = 'error-text';
          // Insert after the input element
          if (inputEl.nextSibling) inputEl.parentElement.insertBefore(helper, inputEl.nextSibling.nextSibling || inputEl.nextSibling);
          else inputEl.parentElement.appendChild(helper);
        }
        helper.textContent = message || 'Invalid value';
      }

      function clearFieldErrors() {
        if (!modalForm) return;
        modalForm.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        modalForm.querySelectorAll('.error-text').forEach(el => el.remove());
      }

      function addRealtimeValidationHandlers() {
        if (!modalForm) return;
        modalForm.querySelectorAll('input,select,textarea').forEach(el => {
          el.addEventListener('input', () => {
            if (el.classList.contains('invalid')) {
              el.classList.remove('invalid');
              const helper = el.parentElement && el.parentElement.querySelector('.error-text');
              if (helper) helper.remove();
            }
            clearFormError();
          });
        });
      }

      function handleFieldConflicts(type, message) {
        const msg = String(message || '').toLowerCase();
        const isName = msg.includes('name already in use') || msg.includes('name already taken');
        const isNumber = msg.includes('number already in use') || msg.includes('number already taken');
        let targetNames = [];
        if (type === 'cow' || type === 'bull') {
          if (isName) targetNames.push('registeringName');
          if (isNumber) targetNames.push('registeringNumber');
        } else if (type === 'calf') {
          if (isName) targetNames.push('calfName');
        }
        if (targetNames.length) {
          targetNames.forEach(n => markInvalid(modalForm.querySelector(`[name="${n}"]`), 'Already in use'));
          if (targetNames[0]) {
            const first = modalForm.querySelector(`[name="${targetNames[0]}"]`);
            if (first) first.focus();
          }
          setFormError(message);
        }
      }

      // Confirm Modal helpers
      let _confirmCb = null;
      function openConfirmModal(title, bodyHtml, onConfirm, opts) {
        const cm = document.getElementById('confirm-modal');
        document.getElementById('confirm-title').textContent = title || 'Confirm';
        document.getElementById('confirm-body').innerHTML = bodyHtml || '';
        _confirmCb = typeof onConfirm === 'function' ? onConfirm : null;
        cm.style.display = 'block';
        const yes = document.getElementById('confirm-yes');
        // Remove previous listener by cloning
        const newYes = yes.cloneNode(true);
        yes.parentNode.replaceChild(newYes, yes);
        // Apply dynamic label and variant style
        const label = (opts && opts.label) || 'Confirm';
        const variant = (opts && opts.variant) || 'primary';
        newYes.textContent = label;
        let bg = '#0d6efd';
        if (variant === 'danger') bg = '#dc3545';
        else if (variant === 'success') bg = '#198754';
        newYes.style.backgroundColor = bg;
        newYes.addEventListener('click', () => {
          if (_confirmCb) _confirmCb();
        });
      }
      function closeConfirmModal() {
        const cm = document.getElementById('confirm-modal');
        cm.style.display = 'none';
        document.getElementById('confirm-body').innerHTML = '';
        _confirmCb = null;
      }

      // Notes Viewer logic
      function openNotesViewer(btn) {
        const modalEl = document.getElementById('notes-viewer-modal');
        const ta = document.getElementById('notes-viewer-textarea');
        const raw = btn.getAttribute('data-notes') || '';
        ta.value = raw;
        modalEl.dataset.targetType = btn.getAttribute('data-type');
        modalEl.dataset.targetId = btn.getAttribute('data-id');
        modalEl.dataset.originalNotes = raw;
        modalEl.style.display = 'block';
      }

      function closeNotesViewer() {
        const modalEl = document.getElementById('notes-viewer-modal');
        modalEl.style.display = 'none';
        document.getElementById('notes-viewer-textarea').value = '';
        delete modalEl.dataset.targetType;
        delete modalEl.dataset.targetId;
        delete modalEl.dataset.originalNotes;
      }

      // Close notes viewer when clicking outside
      window.addEventListener('click', (e) => {
        const nv = document.getElementById('notes-viewer-modal');
        if (nv.style.display === 'block' && e.target === nv) {
          closeNotesViewer();
        }
      });

      async function saveNotesFromViewer() {
        const modalEl = document.getElementById('notes-viewer-modal');
        const type = modalEl.dataset.targetType;
        const id = modalEl.dataset.targetId;
        const originalNotes = modalEl.dataset.originalNotes || '';
        const newNotes = document.getElementById('notes-viewer-textarea').value;
        if (!type || !id) {
          showCustomPopup('Missing target for notes update.', 'error');
          return;
        }
        if (newNotes === originalNotes) {
          showCustomPopup('No changes in notes.', 'info');
          closeNotesViewer();
          return;
        }
        try {
          const response = await fetch('/edit-cattle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, type, updates: { notes: newNotes } })
          });
          if (response.ok) {
            await response.json();
            closeNotesViewer();
            showCustomPopup('Notes updated successfully!', 'success');
            setTimeout(() => location.reload(), 300);
          } else {
            const errText = await response.text();
            showCustomPopup('Error updating notes: ' + errText, 'error');
          }
        } catch (err) {
          console.error(err);
          showCustomPopup('An error occurred while saving notes.', 'error');
        }
      }

      // Handle deep links from Viewer (auto-open edit modal)
      window.addEventListener('DOMContentLoaded', () => {
        // Support hash-based deep link (#edit:type:id) and query param (?edit=type:id)
        let type=null, id=null;
        const h = (location.hash || '').slice(1);
        const partsH = h.split(':');
        if (partsH[0] === 'edit' && partsH.length >= 3) {
          type = partsH[1];
          id = partsH[2];
        }
        if (!type || !id) {
          const qp = new URLSearchParams(location.search).get('edit');
          if (qp) {
            const partsQ = qp.split(':');
            if (partsQ.length === 2){ type=partsQ[0]; id=partsQ[1]; }
          }
        }
        if (type && id) {
          openEditModal(type, id);
          // Clean URL without removing other params
          const url = new URL(location.href);
          url.searchParams.delete('edit');
          history.replaceState(null, '', url.pathname + url.search);
        }
      });

      // Focus handling from profile pages (?focus=type:id&openInfo=true)
      (function handleRegistryFocus(){
        const params=new URLSearchParams(location.search);
        const focus=params.get('focus');
        if(!focus) return;
        const openInfo=params.get('openInfo');
        const parts=focus.split(':');
        if(parts.length!==2) return;
        const type=parts[0];
        const id=parts[1];
        const row=document.getElementById(type+'-row-'+id);
        if(!row) return;
        // Scroll into view and highlight
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.style.outline='3px solid #0d6efd';
        row.style.backgroundColor='#eaf4ff';
        setTimeout(()=>{ row.style.outline='none'; row.style.backgroundColor=''; }, 2600);
        if(openInfo){
          // open more info section
          toggleMoreInfo(type,id);
        }
      })();

  </script>
  </main>
  <%- include('partials/footer') %>
</body>
</html>