<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('partials/header') %>

    <nav class="sidebar" id="sidebar">
      
      <div class="brand" style="display: flex; align-items: center;">
        <button class="close-sidebar" aria-label="Close navigation" style="background: transparent; border: none; cursor: pointer; margin-right: 10px; position: relative;">
          <span style="display: block; width: 20px; height: 2px; background: black; transform: rotate(45deg); position: absolute; top: 50%; left: 50%; transform-origin: center; margin: -1px 0 0 -10px;"></span>
          <span style="display: block; width: 20px; height: 2px; background: black; transform: rotate(-45deg); position: absolute; top: 50%; left: 50%; transform-origin: center; margin: -1px 0 0 -10px;"></span>
        </button>
        <img src="/images/icons/logo.png" alt="Sweet Cow Logo">
        <h1>Sweet Cow</h1>
      </div>
      <ul class="nav">
        <li><a href="/" class="<%= title === 'SweetCow Dashboard' ? 'active' : '' %>">Dashboard</a></li>
        <li><a href="/cattle-management" class="<%= title === 'Cattle Management' ? 'active' : '' %>">Cattle Management</a></li>
        <li><a href="/settings" class="<%= title === 'Settings' ? 'active' : '' %>">Settings</a></li>
      </ul>
      <footer><span class="tag"><span class="dot"></span> Online</span></footer>
    </nav>

    <main class="content" style="padding: 20px;">
      <h2 style="margin-bottom: 20px;">Settings</h2>
      <section class="card" style="max-width: 800px; margin: 0 auto;">
        <h3 style="margin-bottom: 20px;">Important Dates Configuration</h3>
        <form action="/settings" method="POST" style="display: flex; flex-direction: column; gap: 30px;">
          <fieldset style="border: none;">
            <legend style="font-weight: bold; margin-bottom: 10px;">General Settings</legend>
            <div class="field">
              <label for="dryOffAfterSuccessfulInsemDays">Dry-Off After Successful Insemination (Days)</label>
              <input type="number" id="dryOffAfterSuccessfulInsemDays" name="dryOffAfterSuccessfulInsemDays" value="<%= settings.dryOffAfterSuccessfulInsemDays %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="changeFeedAfterSuccessfulInsemDays">Change Feed After Successful Insemination (Days)</label>
              <input type="number" id="changeFeedAfterSuccessfulInsemDays" name="changeFeedAfterSuccessfulInsemDays" value="<%= settings.changeFeedAfterSuccessfulInsemDays %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="gestationDays">Gestation Period (Days)</label>
              <input type="number" id="gestationDays" name="gestationDays" value="<%= settings.gestationDays %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="postpartumInseminationStartDays">Postpartum Insemination Start (Days After Actual Birth)</label>
              <input type="number" id="postpartumInseminationStartDays" name="postpartumInseminationStartDays" value="<%= (settings.postpartumInseminationStartDays != null ? settings.postpartumInseminationStartDays : 60) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="inseminationIntervalDays">Insemination Interval (Days, Retry Window)</label>
              <input type="number" id="inseminationIntervalDays" name="inseminationIntervalDays" value="<%= (settings.inseminationIntervalDays != null ? settings.inseminationIntervalDays : (settings.inseminationIntervalMonths != null ? settings.inseminationIntervalMonths*30 : 90)) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
          </fieldset>

          <fieldset style="border: none;">
            <legend style="font-weight: bold; margin-bottom: 10px;">Alerts</legend>
            <div class="field">
              <label for="calvingAlertBeforeDays">Calving Alert Before (Days)</label>
              <input type="number" id="calvingAlertBeforeDays" name="calvingAlertBeforeDays" value="<%= (settings.calvingAlertBeforeDays != null ? settings.calvingAlertBeforeDays : 10) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="dryOffAlertBeforeDays">Dry-Off Alert Before (Days)</label>
              <input type="number" id="dryOffAlertBeforeDays" name="dryOffAlertBeforeDays" value="<%= (settings.dryOffAlertBeforeDays != null ? settings.dryOffAlertBeforeDays : 1) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="changeFeedAlertBeforeDays">Change Feed Alert Before (Days)</label>
              <input type="number" id="changeFeedAlertBeforeDays" name="changeFeedAlertBeforeDays" value="<%= (settings.changeFeedAlertBeforeDays != null ? settings.changeFeedAlertBeforeDays : 1) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="pregnancyCheckAlertBeforeDays">Pregnancy Check Alert Before (Days)</label>
              <input type="number" id="pregnancyCheckAlertBeforeDays" name="pregnancyCheckAlertBeforeDays" value="<%= (settings.pregnancyCheckAlertBeforeDays != null ? settings.pregnancyCheckAlertBeforeDays : 3) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="inseminationAlertBeforeDays">Insemination Alert Before (Days)</label>
              <input type="number" id="inseminationAlertBeforeDays" name="inseminationAlertBeforeDays" value="<%= (settings.inseminationAlertBeforeDays != null ? settings.inseminationAlertBeforeDays : 0) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="graduationAlertBeforeDays">Graduation Alert Before (Days)</label>
              <input type="number" id="graduationAlertBeforeDays" name="graduationAlertBeforeDays" value="<%= (settings.graduationAlertBeforeDays != null ? settings.graduationAlertBeforeDays : 7) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="weaningAlertBeforeDays">Weaning Alert Before (Days)</label>
              <input type="number" id="weaningAlertBeforeDays" name="weaningAlertBeforeDays" value="<%= (settings.weaningAlertBeforeDays != null ? settings.weaningAlertBeforeDays : 7) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
          </fieldset>

          <fieldset style="border: none;">
            <legend style="font-weight: bold; margin-bottom: 10px;">Calf Management</legend>
            <div class="field">
              <label for="femaleWeaningDays">Female Weaning (Days)</label>
              <input type="number" id="femaleWeaningDays" name="femaleWeaningDays" value="<%= (settings.femaleWeaningDays != null ? settings.femaleWeaningDays : (settings.weaningDays != null ? settings.weaningDays : 180)) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="maleWeaningDays">Male Weaning (Days)</label>
              <input type="number" id="maleWeaningDays" name="maleWeaningDays" value="<%= (settings.maleWeaningDays != null ? settings.maleWeaningDays : (settings.weaningDays != null ? settings.weaningDays : 180)) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="femaleMaturityMonths">Female: Calf → Cow (Months)</label>
              <input type="number" id="femaleMaturityMonths" name="femaleMaturityMonths" value="<%= (settings.femaleMaturityMonths != null ? settings.femaleMaturityMonths : 24) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="maleMaturityMonths">Male: Calf → Bull (Months)</label>
              <input type="number" id="maleMaturityMonths" name="maleMaturityMonths" value="<%= (settings.maleMaturityMonths != null ? settings.maleMaturityMonths : 24) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
            <div class="field">
              <label for="maleSellAgeMonths">Male Calf/Bull Sell Age (Months)</label>
              <input type="number" id="maleSellAgeMonths" name="maleSellAgeMonths" value="<%= (settings.maleSellAgeMonths != null ? settings.maleSellAgeMonths : (settings.maleSellMonths != null ? settings.maleSellMonths : (settings.bullSellAgeMonths != null ? settings.bullSellAgeMonths : 16))) %>" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
          </fieldset>
          <button type="submit" id="save-settings" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">Save Settings</button>
        </form>

        <div id="confirmation" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
          <h4>Settings Updated</h4>
          <ul id="changed-settings" style="list-style: none; padding: 0;">
            <!-- Changes will be dynamically added here -->
          </ul>
          <button onclick="document.getElementById('confirmation').style.display = 'none';" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirm</button>
        </div>

        <div id="popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 400px;">
            <h4 id="popup-title">Confirm Changes</h4>
            <ul id="popup-changed-settings" style="list-style: none; padding: 0; margin-bottom: 20px;">
              <!-- Changes will be dynamically added here -->
            </ul>
            <div id="popup-buttons" style="display: flex; justify-content: space-between;">
              <button id="confirm-button" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirm</button>
              <button id="decline-button" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">Decline</button>
            </div>
            <button id="okay-button" style="display: none; margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">Okay</button>
          </div>
        </div>
      </section>
    </main>

    <script>
      // Expose settings (with fallbacks) for other pages via localStorage so cattle-registry can read them
      try {
        const exposedSettings = JSON.parse(`<%- JSON.stringify({
          gestationDays: settings.gestationDays,
          dryOffAfterSuccessfulInsemDays: settings.dryOffAfterSuccessfulInsemDays,
          changeFeedAfterSuccessfulInsemDays: settings.changeFeedAfterSuccessfulInsemDays,
          postpartumInseminationStartDays: (settings.postpartumInseminationStartDays != null ? settings.postpartumInseminationStartDays : 60),
          inseminationIntervalDays: (settings.inseminationIntervalDays != null ? settings.inseminationIntervalDays : (settings.inseminationIntervalMonths != null ? settings.inseminationIntervalMonths*30 : 90)),
          bullSellAgeMonths: (settings.bullSellAgeMonths != null ? settings.bullSellAgeMonths : 24),
          femaleWeaningDays: (settings.femaleWeaningDays != null ? settings.femaleWeaningDays : (settings.weaningDays != null ? settings.weaningDays : 180)),
          maleWeaningDays: (settings.maleWeaningDays != null ? settings.maleWeaningDays : (settings.weaningDays != null ? settings.weaningDays : 180)),
          femaleMaturityMonths: (settings.femaleMaturityMonths != null ? settings.femaleMaturityMonths : 24),
          maleMaturityMonths: (settings.maleMaturityMonths != null ? settings.maleMaturityMonths : 24)
        }) %>`);
        // Dynamic alert lead times read from form inputs (not persisted yet server-side)
        exposedSettings.calvingAlertBeforeDays = parseInt(document.getElementById('calvingAlertBeforeDays').value || String(<%= (settings.calvingAlertBeforeDays != null ? settings.calvingAlertBeforeDays : 10) %>),10);
        exposedSettings.dryOffAlertBeforeDays = parseInt(document.getElementById('dryOffAlertBeforeDays').value || String(<%= (settings.dryOffAlertBeforeDays != null ? settings.dryOffAlertBeforeDays : 1) %>),10);
        exposedSettings.changeFeedAlertBeforeDays = parseInt(document.getElementById('changeFeedAlertBeforeDays').value || String(<%= (settings.changeFeedAlertBeforeDays != null ? settings.changeFeedAlertBeforeDays : 1) %>),10);
        exposedSettings.pregnancyCheckAlertBeforeDays = parseInt(document.getElementById('pregnancyCheckAlertBeforeDays').value || String(<%= (settings.pregnancyCheckAlertBeforeDays != null ? settings.pregnancyCheckAlertBeforeDays : 3) %>),10);
        exposedSettings.inseminationAlertBeforeDays = parseInt(document.getElementById('inseminationAlertBeforeDays').value || String(<%= (settings.inseminationAlertBeforeDays != null ? settings.inseminationAlertBeforeDays : 0) %>),10);
        exposedSettings.graduationAlertBeforeDays = parseInt(document.getElementById('graduationAlertBeforeDays').value || String(<%= (settings.graduationAlertBeforeDays != null ? settings.graduationAlertBeforeDays : 7) %>),10);
        exposedSettings.weaningAlertBeforeDays = parseInt(document.getElementById('weaningAlertBeforeDays').value || String(<%= (settings.weaningAlertBeforeDays != null ? settings.weaningAlertBeforeDays : 7) %>),10);
        localStorage.setItem('sweetcow_settings', JSON.stringify(exposedSettings));
      } catch(e) { console.warn('Could not persist settings locally', e); }

      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger');
      const closeSidebar = document.querySelectorAll('.close-sidebar');

      hamburger.addEventListener('click', () => {
        sidebar.classList.toggle('open');
      });

      closeSidebar.forEach(button => {
        button.addEventListener('click', () => {
          sidebar.classList.remove('open');
        });
      });

      document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
          sidebar.classList.remove('open');
        }
      });

      const form = document.querySelector('form');
      const confirmation = document.getElementById('confirmation');
      const changedSettings = document.getElementById('changed-settings');
      const popup = document.getElementById('popup');
      const popupTitle = document.getElementById('popup-title');
      const popupChangedSettings = document.getElementById('popup-changed-settings');
      const popupButtons = document.getElementById('popup-buttons');
      const confirmButton = document.getElementById('confirm-button');
      const declineButton = document.getElementById('decline-button');
      const okayButton = document.getElementById('okay-button');

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(form);
        const changes = [];

        formData.forEach((value, key) => {
          const input = document.getElementById(key);
          if (input && input.defaultValue !== value) {
            changes.push(`${input.previousElementSibling.textContent}: ${input.defaultValue} → ${value}`);
          }
        });

        if (changes.length === 0) {
          popupTitle.textContent = 'No Changes';
          popupChangedSettings.innerHTML = '<li>Nothing to save.</li>';
          popupButtons.style.display = 'none';
          okayButton.style.display = 'block';
        } else {
          popupTitle.textContent = 'Confirm Changes';
          popupChangedSettings.innerHTML = changes.map(change => `<li>${change}</li>`).join('');
          popupButtons.style.display = 'flex';
          okayButton.style.display = 'none';
        }

        popup.style.display = 'block';
      });

      confirmButton.addEventListener('click', () => {
        popup.style.display = 'none';
        form.submit();
      });

      declineButton.addEventListener('click', () => {
        popup.style.display = 'none';
      });

      okayButton.addEventListener('click', () => {
        popup.style.display = 'none';
      });
    </script>

    <%- include('partials/footer') %>
</body>
</html>